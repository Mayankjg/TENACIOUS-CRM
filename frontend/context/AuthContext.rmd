
AuthContext.jsx

"use client";

import React, { createContext, useContext, useEffect, useState } from "react";
import axios from "axios";
import Cookies from "js-cookie";

const AuthContext = createContext();

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(null);
  const [tokenReady, setTokenReady] = useState(false); 
  const [loading, setLoading] = useState(true);

  axios.defaults.baseURL = "https://tt-crm-pro.onrender.com";
  axios.defaults.withCredentials = true;
  
  // LOAD STORED USER + TOKEN
  useEffect(() => {
    const savedUser = localStorage.getItem("ts-user");
    const savedToken =
      localStorage.getItem("ts-token") || Cookies.get("ts-token");

    if (savedUser) setUser(JSON.parse(savedUser));

    if (savedToken) {
      setToken(savedToken);
      axios.defaults.headers.common["Authorization"] = `Bearer ${savedToken}`;
    }

    setTokenReady(true); 
    setLoading(false);
  }, []);

  // SIGNUP
  async function signupUser(formData) {
    const res = await axios.post("/api/auth/register", formData);
    return res.data;
  }

  // LOGIN
  async function loginUser(formData) {
    const res = await axios.post("/api/auth/login", formData);

    const { user, token } = res.data;

    localStorage.setItem("ts-user", JSON.stringify(user));
    localStorage.setItem("ts-token", token);
    Cookies.set("ts-token", token);

    setUser(user);
    setToken(token);

    axios.defaults.headers.common["Authorization"] = `Bearer ${token}`;
    setTokenReady(true); // <-- available immediately

    return res.data;
  }
  // LOGOUT
  function logout() {
    localStorage.removeItem("ts-user");
    localStorage.removeItem("ts-token");
    Cookies.remove("ts-token");

    delete axios.defaults.headers.common["Authorization"];

    setUser(null);
    setToken(null);
    setTokenReady(false);
  }

  return (
    <AuthContext.Provider
      value={{
        user,
        token,
        tokenReady,
        loading,
        signupUser,
        loginUser,
        logout,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  return useContext(AuthContext);
}